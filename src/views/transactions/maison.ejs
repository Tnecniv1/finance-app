<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maison - Fidess</title>
</head>
<body>
    <%- include('../partials/navbar-simple', { currentPage: 'maison', user: user }) %>

    <div class="main-content">
        <!-- 3 Blocs cliquables -->
        <div class="action-blocks">
            <a href="/optimisation/start" class="action-block">
                <div class="block-icon">‚ö°</div>
                <div class="block-title">Optimiser</div>
            </a>

            <a href="/progression" class="action-block">
                <div class="block-icon">üìä</div>
                <div class="block-title">Progression</div>
            </a>

            <a href="/classement" class="action-block">
                <div class="block-icon">üèÜ</div>
                <div class="block-title">Classement</div>
            </a>
        </div>

        <!-- Grand cadre avec visualisation de pixels -->
        <div class="center-frame">
            <% if (visualisation) { %>

                <!-- En-t√™te du projet -->
                <div class="projet-header">
                    <div class="projet-info">
                        <h2 class="projet-nom">üéØ <%= visualisation.projet.nom %></h2>
                        <p class="projet-description">
                            <% if (visualisation.projet.description) { %>
                                <%= visualisation.projet.description %>
                            <% } %>
                        </p>
                    </div>
                    <div class="projet-stats">
                        <div class="stat-item">
                            <span class="stat-label">Profit</span>
                            <span class="stat-value <%= visualisation.estNegatif ? 'negative' : 'positive' %>">
                                <%= visualisation.solde.toLocaleString('fr-FR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %>‚Ç¨
                            </span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Objectif</span>
                            <span class="stat-value">
                                <%= visualisation.montantObjectif.toLocaleString('fr-FR', { minimumFractionDigits: 0 }) %>‚Ç¨
                            </span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Progression</span>
                            <span class="stat-value <%= visualisation.estNegatif ? 'negative' : 'positive' %>">
                                <%= visualisation.estNegatif ? '-' : '+' %><%= visualisation.pourcentageAffiche %>%
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Grille de pixels -->
                <div class="pixel-container">
                    <canvas id="pixelCanvas"></canvas>
                </div>

            <% } else { %>
                <!-- Pas de projet actif -->
                <div class="no-project">
                    <div class="no-project-icon">üéØ</div>
                    <h3>Aucun projet actif</h3>
                    <p>Cr√©ez votre premier projet financier pour visualiser votre progression !</p>
                    <a href="/infos" class="btn-create-project">
                        <span>‚ûï</span> Cr√©er un projet
                    </a>
                </div>
            <% } %>
        </div>
    </div>

    <style>
        .main-content {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        /* 3 Blocs d'action */
        .action-blocks {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
        }

        .action-block {
            background: white;
            padding: 40px 20px;
            border-radius: 15px;
            text-align: center;
            text-decoration: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .action-block:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.2);
        }

        .block-icon {
            font-size: 64px;
            margin-bottom: 15px;
        }

        .block-title {
            font-size: 20px;
            font-weight: 600;
            color: #333;
        }

        /* Grand cadre central */
        .center-frame {
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 40px;
            max-width: 1000px;
            margin: 0 auto;
            width: 100%;
        }

        /* En-t√™te du projet */
        .projet-header {
            margin-bottom: 30px;
        }

        .projet-nom {
            font-size: 28px;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 10px;
        }

        .projet-description {
            color: #6c757d;
            font-size: 16px;
            margin-bottom: 20px;
        }

        .projet-stats {
            display: flex;
            justify-content: space-around;
            gap: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-top: 20px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-label {
            display: block;
            font-size: 14px;
            color: #6c757d;
            margin-bottom: 8px;
        }

        .stat-value {
            display: block;
            font-size: 24px;
            font-weight: 700;
            font-family: 'Courier New', monospace;
        }

        .stat-value.positive {
            color: #28a745;
        }

        .stat-value.negative {
            color: #dc3545;
        }

        /* Grille de pixels */
        .pixel-container {
            margin: 30px 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 400px;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
        }

        #pixelCanvas {
            max-width: 100%;
            height: auto;
            border-radius: 5px;
        }

        /* L√©gende */
        .legend {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }

        .legend-label {
            font-size: 14px;
            color: #6c757d;
        }

        /* Pas de projet */
        .no-project {
            text-align: center;
            padding: 60px 20px;
        }

        .no-project-icon {
            font-size: 80px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .no-project h3 {
            font-size: 24px;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 10px;
        }

        .no-project p {
            font-size: 16px;
            color: #6c757d;
            margin-bottom: 30px;
        }

        .btn-create-project {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 15px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-decoration: none;
            border-radius: 10px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-create-project:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .action-blocks {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .action-block {
                padding: 30px 20px;
            }

            .block-icon {
                font-size: 48px;
            }

            .block-title {
                font-size: 18px;
            }

            .center-frame {
                padding: 30px 20px;
            }

            .projet-stats {
                flex-direction: column;
                gap: 15px;
            }

            .stat-value {
                font-size: 20px;
            }

            .pixel-container {
                min-height: 300px;
                padding: 10px;
            }
        }
    </style>

    <% if (visualisation) { %>
    <script>
        // Configuration de la grille de pixels
        const config = {
            totalPixels: <%= visualisation.totalPixels %>,
            pixelsColores: <%= visualisation.pixelsColores %>,
            estNegatif: <%= visualisation.estNegatif ? 'true' : 'false' %>,
            gridSize: 100, // Grille 100x100
            pixelSize: 4, // Taille de chaque pixel en px
            pixelGap: 1 // Espacement entre les pixels
        };

        // Initialiser le canvas
        const canvas = document.getElementById('pixelCanvas');
        const ctx = canvas.getContext('2d');

        // Calculer les dimensions du canvas
        const totalSize = config.gridSize * (config.pixelSize + config.pixelGap);
        canvas.width = totalSize;
        canvas.height = totalSize;

        // Couleurs
        const colors = {
            filled: config.estNegatif ? '#000000' : '#667eea', // Noir si dette, violet sinon
            empty: '#f0f0f0'
        };

        // Fonction pour dessiner un pixel
        function drawPixel(x, y, color) {
            ctx.fillStyle = color;
            const posX = x * (config.pixelSize + config.pixelGap);
            const posY = y * (config.pixelSize + config.pixelGap);
            ctx.fillRect(posX, posY, config.pixelSize, config.pixelSize);
        }

        // Dessiner la grille
        function drawGrid() {
            let pixelIndex = 0;
            
            for (let y = 0; y < config.gridSize; y++) {
                for (let x = 0; x < config.gridSize; x++) {
                    const color = pixelIndex < config.pixelsColores ? colors.filled : colors.empty;
                    drawPixel(x, y, color);
                    pixelIndex++;
                }
            }
        }

        // Animation au chargement (remplissage progressif)
        function animateGrid() {
            let currentPixel = 0;
            const animationSpeed = config.pixelsColores > 1000 ? 1 : 5; // Vitesse adaptative
            
            const interval = setInterval(() => {
                if (currentPixel >= config.pixelsColores) {
                    clearInterval(interval);
                    return;
                }
                
                // Dessiner les pixels progressivement
                for (let i = 0; i < animationSpeed && currentPixel < config.pixelsColores; i++) {
                    const x = currentPixel % config.gridSize;
                    const y = Math.floor(currentPixel / config.gridSize);
                    drawPixel(x, y, colors.filled);
                    currentPixel++;
                }
                
                // Dessiner le reste en blanc
                for (let y = 0; y < config.gridSize; y++) {
                    for (let x = 0; x < config.gridSize; x++) {
                        const index = y * config.gridSize + x;
                        if (index >= currentPixel) {
                            drawPixel(x, y, colors.empty);
                        }
                    }
                }
            }, 10);
        }

        // Lancer l'animation au chargement
        window.addEventListener('load', () => {
            // D'abord dessiner la grille vide
            for (let y = 0; y < config.gridSize; y++) {
                for (let x = 0; x < config.gridSize; x++) {
                    drawPixel(x, y, colors.empty);
                }
            }
            
            // Puis animer le remplissage
            setTimeout(animateGrid, 300);
        });
    </script>
    <% } %>
</body>
</html>
