<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>√âtape 3 : R√©capitulatif | Optimisation</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body {
      background-color: #f8f9fa;
      padding: 20px 0;
    }
    .progress-container {
      max-width: 800px;
      margin: 0 auto 30px;
      padding: 0 15px;
    }
    .progress {
      height: 8px;
      border-radius: 10px;
      background-color: #e9ecef;
    }
    .progress-bar {
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      border-radius: 10px;
    }
    .step-label {
      text-align: center;
      margin-top: 10px;
      color: #6c757d;
      font-weight: 500;
    }
    .container {
      max-width: 1100px;
    }
    .card {
      border: none;
      border-radius: 15px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.08);
      margin-bottom: 30px;
    }
    .card-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 25px 30px;
      border: none;
      border-radius: 15px 15px 0 0 !important;
    }
    .card-header h2 {
      margin: 0;
      font-size: 1.8rem;
      font-weight: 600;
    }
    .card-body {
      padding: 30px;
    }
    .solde-box {
      padding: 30px;
      border-radius: 15px;
      text-align: center;
      margin-bottom: 30px;
      background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
      color: white;
    }
    .solde-box.deficit {
      background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
    }
    .solde-box h3 {
      font-size: 3rem;
      font-weight: 700;
      margin-bottom: 10px;
    }
    .solde-box p {
      font-size: 1.2rem;
      opacity: 0.9;
      margin: 0;
    }
    .stats-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    .stat-card {
      background: white;
      border: 2px solid #e9ecef;
      border-radius: 12px;
      padding: 20px;
      text-align: center;
    }
    .stat-card h5 {
      font-size: 0.9rem;
      color: #6c757d;
      margin-bottom: 10px;
      font-weight: 600;
    }
    .stat-card .value {
      font-size: 2rem;
      font-weight: 700;
      color: #333;
    }
    .stat-card.revenus .value {
      color: #28a745;
    }
    .stat-card.depenses .value {
      color: #dc3545;
    }
    .stat-card.economie .value {
      color: #667eea;
    }
    .alert-deficit {
      background-color: #f8d7da;
      border: 2px solid #dc3545;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 30px;
    }
    .alert-deficit h5 {
      color: #721c24;
      margin-bottom: 15px;
      font-weight: 600;
    }
    .alert-deficit .btn {
      margin-top: 10px;
    }
    .table-recap {
      margin-bottom: 30px;
    }
    .table-recap thead {
      background-color: #f8f9fa;
    }
    .table-recap th {
      padding: 15px;
      font-weight: 600;
      border: none;
    }
    .table-recap td {
      padding: 15px;
      vertical-align: middle;
    }
    .table-recap tbody tr:hover {
      background-color: #f8f9fa;
    }
    .category-row {
      background-color: #e7f3ff;
      font-weight: 600;
    }
    .montant-actuel {
      color: #dc3545;
      font-weight: 600;
    }
    .montant-optimal {
      color: #28a745;
      font-weight: 600;
    }
    .economie-positive {
      color: #28a745;
      font-weight: 600;
    }
    .economie-negative {
      color: #dc3545;
      font-weight: 600;
    }
    .actions-section {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 30px;
    }
    .actions-section h4 {
      margin-bottom: 20px;
      font-weight: 600;
    }
    .action-item {
      background: white;
      border-left: 4px solid #667eea;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .action-item.priorite-1 {
      border-left-color: #dc3545;
    }
    .action-item.priorite-2 {
      border-left-color: #ffc107;
    }
    .action-item.priorite-3 {
      border-left-color: #28a745;
    }
    .action-description {
      flex: 1;
      font-weight: 500;
    }
    .action-economie {
      background: #e7f3ff;
      padding: 8px 15px;
      border-radius: 20px;
      font-weight: 600;
      color: #667eea;
    }
    .empty-actions {
      text-align: center;
      padding: 40px;
      color: #6c757d;
    }
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: none;
      padding: 15px 40px;
      font-weight: 600;
      font-size: 1.1rem;
      border-radius: 50px;
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
      transition: all 0.3s ease;
    }
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
    }
    .btn-secondary {
      border-radius: 50px;
      padding: 12px 30px;
      font-weight: 600;
    }
    .navigation-buttons {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 30px;
      padding-top: 20px;
      border-top: 2px solid #e9ecef;
    }
  </style>
</head>
<body>
  <%- include('../partials/navbar-simple') %>
  <!-- Barre de progression -->
  <div class="progress-container">
    <div class="progress">
      <div class="progress-bar" role="progressbar" style="width: 100%" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
    </div>
    <div class="step-label">√âtape 3 sur 3 : R√©capitulatif et validation</div>
  </div>
  
  <div class="container">
    <!-- Carte principale -->
    <div class="card">
      <div class="card-header">
        <h2><i class="fas fa-chart-pie"></i> R√©capitulatif de l'optimisation</h2>
        <p>Mois : <%= moisCible %></p>
      </div>
      
      <div class="card-body">
        <!-- Solde pr√©visionnel -->
        <div class="solde-box <%= alerteDeficit ? 'deficit' : '' %>">
          <p>Solde pr√©visionnel</p>
          <h3><%= solde >= 0 ? '+' : '' %><%= solde.toFixed(2) %>‚Ç¨</h3>
          <% if (alerteDeficit) { %>
            <p><i class="fas fa-exclamation-triangle"></i> Attention : Budget d√©ficitaire</p>
          <% } else { %>
            <p><i class="fas fa-check-circle"></i> Budget √©quilibr√©</p>
          <% } %>
        </div>
        
        <!-- Statistiques -->
        <div class="stats-row">
          <div class="stat-card revenus">
            <h5>üí∞ Revenus optimis√©s</h5>
            <div class="value">+<%= session.revenus_optimises.toFixed(2) %>‚Ç¨</div>
          </div>
          <div class="stat-card depenses">
            <h5>üí∏ D√©penses optimis√©es</h5>
            <div class="value">-<%= session.depenses_optimisees.toFixed(2) %>‚Ç¨</div>
          </div>
          <div class="stat-card economie">
            <h5>üíé √âconomies pr√©vues</h5>
            <div class="value"><%= economieTotale.toFixed(2) %>‚Ç¨</div>
          </div>
        </div>
        
        <!-- Alerte d√©ficit -->
        <% if (alerteDeficit) { %>
          <div class="alert-deficit">
            <h5><i class="fas fa-exclamation-triangle"></i> Budget d√©ficitaire d√©tect√©</h5>
            <p>Vos d√©penses d√©passent vos revenus de <strong><%= Math.abs(solde).toFixed(2) %>‚Ç¨</strong>. Vous pouvez :</p>
            <ul>
              <li>Retourner √† l'√©tape 2 pour r√©duire davantage vos d√©penses</li>
              <li>Ajouter une source de revenus suppl√©mentaire</li>
              <li>Continuer avec ce budget et surveiller vos d√©penses r√©elles</li>
            </ul>
            <a href="/optimisation/etape2" class="btn btn-danger">
              <i class="fas fa-edit"></i> Modifier les budgets
            </a>
          </div>
        <% } %>
        
        <!-- Tableau r√©capitulatif SIMPLIFI√â -->
        <h4 class="mb-3"><i class="fas fa-table"></i> R√©capitulatif par cat√©gorie</h4>
        <div class="table-responsive">
          <table class="table table-recap">
            <thead>
              <tr>
                <th>Cat√©gorie</th>
                <th class="text-end">Mois N-1</th>
                <th class="text-end">Mois N</th>
                <th class="text-end">√âconomie</th>
              </tr>
            </thead>
            <tbody>
              <% budgetsParCategorie.forEach(categorie => { %>
                <tr>
                  <td>
                    <strong><%= categorie.nom %></strong>
                    <span class="badge bg-<%= categorie.type === 'revenu' ? 'success' : 'danger' %> ms-2" style="font-size: 0.7rem;">
                      <%= categorie.type %>
                    </span>
                  </td>
                  <td class="text-end" style="font-weight: 600; color: #6c757d;">
                    <%= categorie.totalActuel.toFixed(2) %>‚Ç¨
                  </td>
                  <td class="text-end" style="font-weight: 600; color: #667eea;">
                    <%= categorie.totalOptimal.toFixed(2) %>‚Ç¨
                  </td>
                  <td class="text-end <%= categorie.economie >= 0 ? 'economie-positive' : 'economie-negative' %>" style="font-weight: 700;">
                    <%= categorie.economie >= 0 ? '+' : '' %><%= categorie.economie.toFixed(2) %>‚Ç¨
                  </td>
                </tr>
              <% }) %>
              
              <!-- Total g√©n√©ral -->
              <tr style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-weight: 700; font-size: 1.1rem;">
                <td>TOTAL</td>
                <td class="text-end">
                  <%= (session.revenus_recurrents - session.depenses_recurrentes).toFixed(2) %>‚Ç¨
                </td>
                <td class="text-end">
                  <%= solde.toFixed(2) %>‚Ç¨
                </td>
                <td class="text-end">
                  <%= economieTotale.toFixed(2) %>‚Ç¨
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        
        <!-- Actions √† r√©aliser -->
        <div class="actions-section">
          <h4><i class="fas fa-tasks"></i> Actions √† r√©aliser</h4>
          <% if (actions.length === 0) { %>
            <div class="empty-actions">
              <i class="fas fa-check-circle" style="font-size: 3rem; opacity: 0.3;"></i>
              <p>Aucune action sp√©cifique n'a √©t√© d√©finie.</p>
              <p class="text-muted"><small>Vous pouvez en ajouter en retournant √† l'√©tape 2.</small></p>
            </div>
          <% } else { %>
            <% actions.forEach(action => { %>
              <div class="action-item priorite-<%= action.priorite %>">
                <div class="action-description">
                  <% if (action.priorite === 1) { %>
                    <span class="badge bg-danger me-2">Haute priorit√©</span>
                  <% } else if (action.priorite === 2) { %>
                    <span class="badge bg-warning text-dark me-2">Moyenne priorit√©</span>
                  <% } else { %>
                    <span class="badge bg-success me-2">Basse priorit√©</span>
                  <% } %>
                  <%= action.description %>
                </div>
                <% if (action.economie_mensuelle > 0) { %>
                  <div class="action-economie">
                    <i class="fas fa-piggy-bank"></i> <%= action.economie_mensuelle.toFixed(2) %>‚Ç¨/mois
                  </div>
                <% } %>
              </div>
            <% }) %>
            <div class="mt-3">
              <strong>√âconomie totale des actions :</strong> 
              <span style="color: #667eea; font-size: 1.2rem; font-weight: 700;">
                <%= economieActions.toFixed(2) %>‚Ç¨/mois
              </span>
            </div>
          <% } %>
        </div>
        
        <!-- Navigation -->
        <form action="/optimisation/etape3/validate" method="POST">
          <div class="navigation-buttons">
            <a href="/optimisation/etape2" class="btn btn-secondary">
              <i class="fas fa-arrow-left"></i> Modifier les d√©penses
            </a>
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-check-circle"></i> Valider et g√©n√©rer le plan
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
